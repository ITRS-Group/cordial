#
# The client transforms environment variables to Servicenow fields, plus
# internal fields prefixed with underscores
#

router:
  url: http://localhost:3000/snow/api/v2
  # the default table on the router side
  default-table: incident
  tls:
    # should we check the router cert? default true
    verify: false
    # chain to validate router connection, if none and verify is true then use system roots
    chain: /path/to/chain.pem

  # different auth types, basic, cert, token etc.
  authentication:
    # the `token` can be any string as long as it is the same on both
    # router and client - the client being either the incident poster or a
    # GET requests for all incidents. To protect the plain text, if
    # required, you can use `geneos aes password` to create an encoded
    # strings that replies on the security of the key file being read-only
    # to the user. This also allows the configuration file to be shared
    # without sharing the plaintext of the key.
    #
    # perhaps allow auto-generated key file for local routers?
    token: ${enc:~/.config/geneos/keyfile.aes:+encs+E33C8DFAFED66ED8EE68019DAEE0106E}

# default snow field settings
defaults:
  - set:
      _sys_id_search: name=${_NETPROBE_HOST}
      _sys_id_table: cmdb_ci
      _id: ${_GATEWAY}${_NETPROBE_HOST}${_MANAGED_ENTITY}${_SAMPLER}${_DATAVIEW}${_ROWNAME}${_COLUMN}
      _subject: "Geneos Alert on ${first:_NETPROBE_HOST:Unknown} | ${first:_DATAVIEW:None} | ${_ROWNAME} | ${_COLUMN}${_HEADLINE} is ${_VALUE}"
      _text: |
        Status Message: ${_STATUSMESSAGE}	
        Severity: ${_SEVERITY}	
        Geneos time: ${_ALERT_CREATED}	
        Category: Alert	
        Gateway: ${_GATEWAY}	
        Managed Entity: ${_MANAGED_ENTITY}	
        Sampler: ${_SAMPLER}	
        Row: ${_ROWNAME}	
        Column/Headline: ${_COLUMN}${_HEADLINE}	
        Value: ${_VALUE} ${_triggerDetails}
      category: Alert
      assignment_group: ${ASSIGNMENT_GROUP}
      urgency: 3
      impact: 3
      state: 1
  - if:
      - ${match:_PLUGIN:FKM}
    then:
      - set:
          # ${replace:_ROWNAME:/#.*$//}
          # ${sedenv:_triggerDetails:/^[\d-]+\s[\d-]+//}
          id: ${_GATEWAY}${_NETPROBE_HOST}${_MANAGED_ENTITY}${_SAMPLER}${_DATAVIEW}${_filename}${replace:_triggerDetails:^[\d-]+\s[\d-]+::}
  - if: ${match:_SEVERITY:(CRITICAL|critical|3)}
    set:
      impact: 1
      urgency: 1
    # ignore the rest
    # skip: true
  - if: ${match:_SEVERITY:(WARNING|warning|2)}
    set:
      impact: 3
      urgency: 3
  - if: ${match:_SEVERITY:(OK|ok|1)}
    set:
      state: 6
      close_code: Closed/Resolved by Caller
      close_notes: Resolved
    unset: [ urgency, impact ]

# profiles, selected from command line; e.g. `opsview`, `INFRA`, `Apps`
#
# format as for `defaults` above
profiles:
  # The `default` profile is only applied if no other profile is given.
  # To set default values for all profiles, use the `defaults` section
  # above
  default:
    - set:
        _subject: ${replace:_NETPROBE_HOST:thinkpad:that}
    - set:
        _text: |
          Status Message: ${_STATUSMESSAGE}
          Severity: ${_SEVERITY}
          Geneos time: ${_ALERT_CREATED}
          Category: Alert
          Gateway: ${_GATEWAY}
          Managed Entity: ${first:_MANAGED_ENTITY:Unknown}
          Sampler: ${first:_SAMPLER:Unknown}
          Row: ${_ROWNAME}
          Column/Headline: ${_COLUMN}${_HEADLINE}
          Value: ${_VALUE} ${_triggerDetails}
          Sub-category: ${snow:subcategory}
          Impact: ${snow:impact}
          Urgency: ${snow:urgency}

  opsview:
    - set:
        _subject: Opsview Alert on ${_NETPROBE_HOST} | ${_DATAVIEW} | ${_ROWNAME} | ${_COLUMN}${_HEADLINE} is ${_VALUE}
    - if: [ '${match:_TAGS:\b(core|access|distribution)\b}' ]
      then:
        - set:
            key: value
        - if: ${match:_DATAVIEW:^(Connectivity|Uptime)}
          then:
            - set:
                subcategory: "Network Device Down"
                impact: 2
                urgency: 2
          skip: true
        - if: ${match:_DATAVIEW:^SNMP}
          then:
            - set:
                subcategory: "Network Security"
                impact: 3
                urgency: 3
        - if: '${match:_DATAVIEW:^NTP}'
          then:
            - set:
                subcategory: "Network Configuration Error"
                impact: 3
                urgency: 3
        - if: ${match:_DATAVIEW:^(Discards|Errors)}
          then:
            - set:
              subcategory: "Network Performance"
              impact: 3
              urgency: 3
        - if:
            - ${match:_DATAVIEW:^Discards}
            - ${match:_STATUSMESSAGE:discards.*(total|in.*out)}
          then:
            - set:
                urgency: 2
        - if:
            - ${match:_DATAVIEW:^Errors}
            - ${match:_STATUSMESSAGE:errors.*(total|in.*out)|interface.*down}
          then:
            - set:
                urgency: 2
        - if:
            - ${match:_DATAVIEW:^Interface}
            - ${match:_STATUSMESSAGE:Interface.*DOWN}
          then:
            - set:
                subcategory: "Network Port Down"
                impact: 2
                urgency: 2
        - if:
            - ${match:_DATAVIEW:^Interface}
            - ${match:_STATUSMESSAGE:SNMP}
          then:
            - set:
                subcategory: "Network Security"
                impact: 3
                urgency: 3
    - set:
        _text: |
            Status Message: ${_STATUSMESSAGE}	
            Severity: ${_SEVERITY}	
            Geneos time: ${_ALERT_CREATED}	
            Category: Alert	
            Gateway: ${_GATEWAY}	
            Managed Entity: ${_MANAGED_ENTITY}	
            Sampler: ${_SAMPLER}	
            Row: ${_ROWNAME}	
            Column/Headline: ${_COLUMN}${_HEADLINE}	
            Value: ${_VALUE}${_triggerDetails}	
            Hashtags: ${_TAGS}	
            Sub-category: ${snow:subcategory}	
            Impact: ${snow:impact}	
            Urgency: ${snow:urgency}

